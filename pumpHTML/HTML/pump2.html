<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Taste Configuration</title>
</head>
<body>
    <h1>Taste Configuration</h1>
    <div>
        <select id="segmentnumber" onchange="changesegment()">
        </select>
    </div>
    <div>
        <label for="pumpNumber1">Pump Number 1:</label>
    </div>
    <div>
        <label for="intensity1">Intensity (0-255):</label>
        <input type="number" id="intensity1" min="0" max="255">
    </div>
    <div>
        <label for="pumpNumber1">Pump Number 2:</label>
    </div>
    <div>
        <label for="intensity2">Intensity (0-255):</label>
        <input type="number" id="intensity2" min="0" max="255">
    </div>
    <div>
        <label for="startDelay">Start Delay:</label>
        <input type="number" id="startDelay">
        <select name="startValueType" id="startValueType">
            <option>milisecond</option>
            <option>second</option>
        </select>
    </div>
    <div>
        <label for="executionTime">Execution Time:</label>
        <input type="number" id="executionTime">
        <select id="executionValueType">
            <option>milisecond</option>
            <option>second</option>
        </select>
    </div>
    <input type="button" onclick="location.href='Menu.html'" value="Back">
    <button id="connectButton">Connect</button>
    <div>
    <button id="AddSegment" onclick="AddSegment()">Add Segment</button>
    <button id="DeleteSegment">Delete This Segment</button>
    </div>
    <div>
        <button id="Save">Save</button>
        <input type="button" onclick="location.href='Load.html';localStorage.setItem('back',1)" value="Load">
    </div>
    <pre id="output"></pre>
    <script>
        class segment{
            constructor(intensity1, intensity2, startDelay, startValueType, executionTime, executionValueType){
                this.intensity1=intensity1; 
                this.intensity2=intensity2;
                this.startDelay=startDelay;
                this.startValueType=startValueType;
                this.executionTime=executionTime;
                this.executionValueType=executionValueType;
            }
        }
        const motorPins = {
            1: { digital1: 2, digital2: 4, pwm: 3 },
            2: { digital1: 6, digital2: 7, pwm: 5 },
        };

        let port;
        let writer;
        var segmentcount=0;
        var segments=[];

        window.onload = ()=>{
        if (sessionStorage.getItem("session")){
            try{
                segments = JSON.parse(sessionStorage.getItem("session"));
                segmentcount = segments.length;
                for (let index = 0; index < segments.length; index++) {
                    const newsegment = document.createElement("option");
                    newsegment.text = "Segment "+(index+1);
                    document.getElementById("segmentnumber").add(newsegment);
                }          
                document.getElementById('intensity1').value=segments[0].intensity1;
                document.getElementById('intensity2').value=segments[0].intensity2;
                document.getElementById('startDelay').value=segments[0].startDelay;
                document.getElementById('startValueType').selectedIndex=segments[0].startValueType;
                document.getElementById('executionTime').value=segments[0].executionTime;
                document.getElementById('executionValueType').selectedIndex=segments[0].executionValueType;
            }catch(error){
                document.getElementById('output').textContent = `Error: ${error}\n`;
            }}
        else
        {   
            AddSegment();
        }}

        document.getElementById('segmentnumber').addEventListener('onChange', async()=>{
            try {
                const segmentindex = document.getElementById('segmentnumber').selectedIndex;
                document.getElementById('output').textContent = `Segment ${segmentindex} selected  `;
                document.getElementById('intensity1').value=segments[segmentindex].intensity1;
                document.getElementById('intensity2').value=segments[segmentindex].intensity2;
                document.getElementById('startDelay').value=segments[segmentindex].startDelay;
                document.getElementById('startValueType').selectedIndex=segments[segmentindex].startValueType;
                document.getElementById('executionTime').value=segments[segmentindex].executionTime;
                document.getElementById('executionValueType').selectedIndex=segments[segmentindex].executionValueType;
            } catch (error) {
                document.getElementById('output').textContent = `Error: ${error}\n`;
            }
        });

        document.getElementById('connectButton').addEventListener('click', async () => {
            try {
                sessionStorage.setItem("session",JSON.stringify(segments));
                document.location.href="Connect.html"
            } catch (error) {
                document.getElementById('output').textContent = `Error: ${error}\n`;
            }
        });

        document.getElementById('Save').addEventListener('click', async () => {
            try {
                sessionStorage.setItem("session",JSON.stringify(segments));
                document.location.href="Save.html"
            } catch (error) {
                document.getElementById('output').textContent += `Error: ${error}\n`;
            }
        });
        
        //Auto save segment value
        document.getElementById("intensity1").addEventListener('blur', async() => {
            try{
                if (intensity1 < 0 || intensity1 > 255) {
                    document.getElementById('output').textContent += 'Invalid intensity for pump 1. Must be between 0 and 255.\n';
                    return;
                }
                segments[document.getElementById('segmentnumber').selectedIndex].intensity1 = document.getElementById("intensity1").value;
            }catch (error){
                document.getElementById('output').textContent += `Error: ${error}\n`;
            }
        });

        document.getElementById("intensity2").addEventListener('blur', async() => {
            try{
                if (intensity2 < 0 || intensity2 > 255) {
                    document.getElementById('output').textContent += 'Invalid intensity for pump 2. Must be between 0 and 255.\n';
                    return;
                }
                segments[document.getElementById('segmentnumber').selectedIndex].intensity2 = document.getElementById("intensity2").value;
            }catch (error){
                document.getElementById('output').textContent += `Error: ${error}\n`;
            }
        });
        document.getElementById("executionTime").addEventListener('blur', async() => {
            try{
            segments[document.getElementById('segmentnumber').selectedIndex].executionTime = document.getElementById("executionTime").value;
            }catch (error){
                document.getElementById('output').textContent += `Error: ${error}\n`;
            }
        });
        document.getElementById("startDelay").addEventListener('blur', async() => {
            try{
            segments[document.getElementById('segmentnumber').selectedIndex].startDelay = document.getElementById("startDelay").value;
            }catch (error){
                document.getElementById('output').textContent += `Error: ${error}\n`;
            }
        });
        document.getElementById("executionValueType").addEventListener('change', async() => {
            try{
            segments[document.getElementById('segmentnumber').selectedIndex].executionValueType = document.getElementById("executionValueType").selectedIndex;
            }catch (error){
                document.getElementById('output').textContent += `Error: ${error}\n`;
            }
        });
        document.getElementById("startValueType").addEventListener('change', async() => {
            try{
            segments[document.getElementById('segmentnumber').selectedIndex].startValueType = document.getElementById("startValueType").selectedIndex;
            }catch (error){
                document.getElementById('output').textContent += `Error: ${error}\n`;
            }
        });

        document.getElementById("DeleteSegment").addEventListener('click', async()=>{
            try {
                segmentcount -= 1;
                await segments.splice(document.getElementById("segmentnumber").selectedIndex,1);
                await document.getElementById('segmentnumber').remove(document.getElementById("segmentnumber").selectedIndex)
                document.getElementById('intensity1').value=segments[0].intensity1;
                document.getElementById('intensity2').value=segments[0].intensity2;
                document.getElementById('startDelay').value=segments[0].startDelay;
                document.getElementById('startValueType').selectedIndex=segments[0].startValueType;
                document.getElementById('executionTime').value=segments[0].executionTime;
                document.getElementById('executionValueType').selectedIndex=segments[0].executionValueType;
            } catch (error) {
                document.getElementById('output').textContent += `Error: ${error}\n`;
            }
        })

        function AddSegment(){
            try {
                segments[segmentcount] = new segment(0,0,0,0,0,0);
                segmentcount += 1;
                var newsegment = document.createElement("option");
                newsegment.text = "Segment "+segmentcount;
                var segmentoption = document.getElementById("segmentnumber");
                segmentoption.add(newsegment);
                document.getElementById('output').textContent = `Segment ${segmentcount} created`;
            } catch(error){
                document.getElementById('output').textContent = `Error: ${error}\n`;
            }
        };

        function changesegment(){
            try {
                const segmentindex = document.getElementById('segmentnumber').selectedIndex;
                document.getElementById('intensity1').value= segments[segmentindex].intensity1;
                document.getElementById('intensity2').value= segments[segmentindex].intensity2;
                document.getElementById('startDelay').value= segments[segmentindex].startDelay;
                document.getElementById('startValueType').selectedIndex=segments[segmentindex].startValueType;
                document.getElementById('executionTime').value=segments[segmentindex].executionTime;
                document.getElementById('executionValueType').selectedIndex=segments[segmentindex].executionValueType;
            } catch (error) {
                document.getElementById('output').textContent = `Error: ${error}\n`;
            }
        };



    </script>
</body>
</html>
